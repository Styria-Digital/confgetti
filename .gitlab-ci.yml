variables:
  PYPI_USER: SECURE
  PYPI_PASSWORD: SECURE

stages:
  - test
  - build
  - deploy
  - cleanup

image:
  python:3.6.1

before_script:
  # adding pip cache
  - export PIP_CACHE_DIR="/home/gitlabci/cache/pip-cache"

test_code:
  stage: test
  script:
    - pip install --extra-index-url="${STYRIA_EXTRA_INDEX_URL}/simple" --trusted-host="pypi.sds.rocks" -e .[test]
    - pytest . --cov=.

test_build:
  stage: build
  script:
    - python setup.py build
    - python setup.py install

deploy:
  stage: deploy
  script:
    # ~/.pypirc
    - 'echo "[distutils]" >> ~/.pypirc'
    - 'echo "index-servers =" >> ~/.pypirc'
    - 'echo "    styria" >> ~/.pypirc'
    - 'echo " " >> ~/.pypirc'
    - 'echo "[styria]" >> ~/.pypirc'
    - 'echo "repository: ${PYPI_REPO}" >> ~/.pypirc'
    - 'echo "username: ${PYPI_USER}" >> ~/.pypirc'
    - 'echo "password: ${PYPI_PASSWORD}" >> ~/.pypirc'
    - python setup.py sdist upload -r styria
    - echo "" > ~/.pypirc && rm ~/.pypirc
  only:
    - tags

cleanup_pypirc:
  stage: cleanup
  when: always   # this is important; run even if preceding stages failed.
  script:
  - rm -vf ~/.pypirc  # we don't want to leave these around, but GitLab may clean up anyway.


